name: Publish Docker Image

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    name: Build and Push to GHCR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Generate image reference
        id: image-ref
        run: |
          echo "image_ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "latest_ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT
      
      - name: Create deployment runbook
        run: |
          cat > deployment-runbook.md << EOF
          # Deployment Runbook - ${{ github.ref_name }}
          
          ## Container Images Published
          
          **Version Tag:**
          \`\`\`
          docker pull ${{ steps.image-ref.outputs.image_ref }}
          \`\`\`
          
          **Latest Tag:**
          \`\`\`
          docker pull ${{ steps.image-ref.outputs.latest_ref }}
          \`\`\`
          
          ## Required Environment Variables
          
          ### Mandatory
          - \`DATABASE_URL\` - PostgreSQL connection string
          - \`JWT_ACCESS_SECRET\` - JWT access token secret (64-char hex)
          - \`JWT_REFRESH_SECRET\` - JWT refresh token secret (64-char hex)
          - \`WEBHOOK_SECRET\` - HMAC webhook signing secret (64-char hex)
          - \`CRM_BASE_URL\` - CRM API base URL
          - \`CRM_SERVICE_TOKEN\` - CRM authentication token (64-char hex)
          
          ### Recommended for Production
          - \`NODE_ENV=production\`
          - \`PORT=5000\`
          - \`LOG_FORMAT=json\`
          - \`CORS_ALLOWED_ORIGINS\` - Comma-separated HTTPS URLs
          - \`RATE_LIMIT_MAX=100\`
          - \`RATE_LIMIT_WINDOW_MS=900000\`
          
          ### Optional (Market Data)
          - \`TWELVEDATA_API_KEY\` - Twelve Data API key
          - \`MARKETAUX_API_KEY\` - Marketaux API key
          - \`EODHD_API_KEY\` - EODHD API key
          
          ## Deployment Steps
          
          1. **Pull the image:**
             \`\`\`bash
             docker pull ${{ steps.image-ref.outputs.image_ref }}
             \`\`\`
          
          2. **Create .env file** from .env.example with all required values
          
          3. **Run with Docker Compose:**
             \`\`\`bash
             docker-compose -f infra/self-host/docker-compose.prod.yml up -d
             \`\`\`
          
          4. **Configure reverse proxy** (Caddy) for HTTPS
          
          5. **Verify health:**
             \`\`\`bash
             curl http://localhost:5000/health
             \`\`\`
          
          ## Reference Documentation
          
          - Self-Host Guide: \`infra/self-host/README-SELF-HOST.md\`
          - Environment Template: \`.env.example\`
          - Main README: \`README.md\`
          
          ## Build Information
          
          - **Git Tag:** ${{ github.ref_name }}
          - **Commit SHA:** ${{ github.sha }}
          - **Build Date:** $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          - **Registry:** ${{ env.REGISTRY }}
          
          EOF
          
          cat deployment-runbook.md
      
      - name: Upload deployment runbook
        uses: actions/upload-artifact@v4
        with:
          name: deployment-runbook-${{ github.ref_name }}
          path: deployment-runbook.md
          retention-days: 90
      
      - name: Upload build logs summary
        run: |
          cat > build-summary.txt << EOF
          Trading Platform - Build Summary
          
          Version: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Built: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          
          Images Published:
          - ${{ steps.image-ref.outputs.image_ref }}
          - ${{ steps.image-ref.outputs.latest_ref }}
          
          Registry: ${{ env.REGISTRY }}
          
          Status: âœ… SUCCESS
          EOF
          
          cat build-summary.txt
      
      - name: Upload build summary
        uses: actions/upload-artifact@v4
        with:
          name: build-summary-${{ github.ref_name }}
          path: build-summary.txt
          retention-days: 90

  create-release-notes:
    name: Create Release Notes
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-runbook-${{ github.ref_name }}
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: deployment-runbook.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
