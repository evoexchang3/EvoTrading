Final touches (no behavior changes, no secret rotations)
Mode & guardrails
New commit on the same PR.
Do not change, rotate, or mask any existing secret or webhook URL anywhere.
Keep runtime behavior identical to current production/Replit.
No server or DNS instructions.
1) Secrets/Webhooks Replacer CLI (add now; uses real values at runtime, but never prints them)
Create a repo-local CLI that works with the existing secrets-manifest.yml.
Must support (no code shown in the PR description):
audit — list all keys/webhooks with purpose, required-at-boot, and file references (never reveal values).
explain <KEY|WEBHOOK_ID> — show what it’s for, where used, required status, and validation rules (no values).
dry-run --from <source> --target <secrets-file> [--docs <allowlist>...] — show exactly what would change (masked), validate formats, refuse if required keys missing.
apply --from <source> --target <secrets-file> [--docs <allowlist>...] --backup — atomic write to the target secrets file only, timestamped backup, preserve unknown keys, never touch application source files; update only explicitly allow-listed non-code docs if requested.
Validation rules: HTTPS for webhook URLs; 64-hex for HMAC/JWT; Postgres URL scheme; numeric tolerance windows; presence of all required keys.
Exit codes: 0 success, 2 diff detected (dry-run), 1 error.
Acceptance in PR body: Commands demonstrated with masked output (not values), showing audit → dry-run → apply flow against a sample source file in CI (apply step skipped in CI).
2) CORS default — confirm non-breaking behavior
Keep deny-by-default for cross-origin, but ensure same-origin requests and WebSocket upgrades continue to work with no env set (this preserves current UX).
In README.md, clearly state that CORS_ALLOWED_ORIGINS enables additional origins and is optional if the UI and API are same-origin.
Acceptance: PR body notes that same-origin continues to work with env unset and that /ws upgrades are unaffected.
3) Rate limiting — ensure it’s env-tunable and safe by default
Confirm the limiter for /api/auth/* and /api/crm/* is controlled by RATE_LIMIT_MAX and RATE_LIMIT_WINDOW_MS.
Defaults must not throttle your existing flows (keep current defaults and document them).
Acceptance: README.md lists the two vars and default values; PR body confirms existing login/CRM flows are untouched with defaults.
4) Webhook secret fallback — keep legacy key as a deprecation path
Confirm the insecure literal default is removed.
Behavior if only the legacy var exists: use it, but log a clear deprecation warning telling ops to move the value to WEBHOOK_SECRET.
Do not alter any secret values.
Acceptance: PR body shows the exact boot-time log message (no values), and confirms success when only the legacy key is present.
5) Docs alignment — no edits to existing values
Where docs previously referenced /api/webhooks/site, keep the original text but append a note that the canonical path is /api/webhooks/trading (matching code).
Do not change or scrub any existing values in docs.
Acceptance: PR body lists the docs files updated with additive notes only.
6) CI polish (build artifacts only)
Ensure CI does not execute apply mode of the replacer; only audit and dry-run are permitted in CI.
Keep secret-scanning in place; it must ignore the target secrets file path and any explicit sample files used for CI demos.
Acceptance: CI passes on PR; secret scan green.