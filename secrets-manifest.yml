# Trading Platform - Secrets and Environment Variables Manifest
# Complete reference for all environment variables and webhooks
# Use this for audit, rotation planning, and deployment validation

version: 1.0.0
last_updated: 2025-01-15

environment_variables:
  # ============================================
  # REQUIRED AT BOOT (Application will crash if missing)
  # ============================================
  
  - name: DATABASE_URL
    required: true
    required_at_boot: true
    purpose: PostgreSQL connection string for shared Neon database
    format: postgresql://username:password@host:port/database?sslmode=require
    example: postgresql://user:pass@ep-host-123.aws.neon.tech/neondb?sslmode=require
    security_level: critical
    shared_with: CRM system (same database)
    rotation_coordination: Must coordinate with CRM team
    code_locations:
      - drizzle.config.ts:3 (validation check)
      - drizzle.config.ts:12 (Drizzle configuration)
      - server/db.ts:5 (database client)
    validation:
      - Must start with postgresql:// or postgres://
      - Must include ?sslmode=require parameter
      - Connection must be testable
  
  - name: JWT_ACCESS_SECRET
    required: true
    required_at_boot: true
    purpose: HMAC secret for signing short-lived JWT access tokens (15min expiry)
    format: 64-character hexadecimal string minimum
    generate_command: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
    security_level: critical
    rotation_strategy: Dual-secret acceptance window recommended
    rotation_impact: All active sessions invalidated immediately
    code_locations:
      - server/services/auth.service.ts:10 (boot validation)
      - server/services/auth.service.ts:17 (initialization)
      - server/services/auth.service.ts:32 (token generation)
      - server/services/auth.service.ts:40 (token verification)
    validation:
      - Minimum 32 characters
      - Recommended 64 characters (hex)
  
  - name: JWT_REFRESH_SECRET
    required: true
    required_at_boot: true
    purpose: HMAC secret for signing long-lived JWT refresh tokens (7 day expiry)
    format: 64-character hexadecimal string minimum
    generate_command: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
    security_level: critical
    rotation_strategy: Dual-secret acceptance window recommended
    rotation_impact: All refresh tokens invalidated (users remain logged in until access token expires)
    code_locations:
      - server/services/auth.service.ts:10 (boot validation)
      - server/services/auth.service.ts:18 (initialization)
      - server/services/auth.service.ts:36 (token generation)
      - server/services/auth.service.ts:44 (token verification)
    validation:
      - Minimum 32 characters
      - Recommended 64 characters (hex)
  
  - name: WEBHOOK_SECRET
    required: true
    required_at_boot: true
    purpose: HMAC-SHA256 secret for signing outbound webhooks to CRM
    format: 64-character hexadecimal string
    generate_command: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
    security_level: critical
    shared_with: CRM system (must match for signature verification)
    rotation_coordination: Must coordinate with CRM team (dual-secret acceptance window)
    deprecated_alternative: SITE_WEBHOOK_SECRET (logs warning, will be removed)
    code_locations:
      - server/crm.ts:12-24 (boot validation and initialization)
      - server/crm.ts:152 (HMAC signature generation)
    validation:
      - Must be exactly 64 hexadecimal characters
      - Cannot be empty or use insecure default
  
  # ============================================
  # OPTIONAL BUT RECOMMENDED FOR PRODUCTION
  # ============================================
  
  - name: CRM_BASE_URL
    required: false
    required_profiles: [staging, production]
    purpose: Base URL for CRM API service calls
    format: https://domain.com/api
    example: https://crm.example.com/api
    security_level: medium
    code_locations:
      - server/crm.ts:8 (initialization)
      - server/crm.ts:139 (webhook sending validation)
      - server/crm.ts:156 (URL construction)
    validation:
      - Must use HTTPS in production
      - Must not end with trailing slash
      - Should be accessible from application server
  
  - name: CRM_SERVICE_TOKEN
    required: false
    required_profiles: [staging, production]
    purpose: Bearer token for bidirectional CRM service API authentication
    format: 64-character hexadecimal string
    generate_command: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
    security_level: high
    used_for:
      - Inbound: CRM -> Trading Platform SSO and user info API
      - Outbound: Trading Platform -> CRM webhook authorization header
    code_locations:
      - server/crm.ts:9 (initialization)
      - server/crm.ts:18 (SSO token endpoint auth validation)
      - server/crm.ts:101 (user info endpoint auth validation)
      - server/crm.ts:160 (outbound webhook Authorization header)
    validation:
      - Recommended 64 hexadecimal characters
      - Must be kept secure
  
  - name: CORS_ALLOWED_ORIGINS
    required: false
    required_profiles: [production]
    purpose: Comma-separated list of allowed CORS origins
    format: https://domain1.com,https://domain2.com
    example: https://app.example.com,https://admin.example.com
    default_behavior: Deny all origins (strict security)
    security_level: high
    code_locations:
      - server/index.ts:14-27 (CORS configuration)
    validation:
      - Must use HTTPS in production
      - Comma-separated, no spaces
      - Empty = deny-by-default
  
  - name: RATE_LIMIT_MAX
    required: false
    purpose: Maximum number of requests per time window
    format: integer
    default: 100
    security_level: medium
    code_locations:
      - server/index.ts:29 (initialization)
      - server/index.ts:32-38 (rate limiter configuration)
    validation:
      - Must be positive integer
      - Recommended: 100-1000 for production
  
  - name: RATE_LIMIT_WINDOW_MS
    required: false
    purpose: Time window for rate limiting in milliseconds
    format: integer (milliseconds)
    default: 900000 (15 minutes)
    security_level: medium
    code_locations:
      - server/index.ts:30 (initialization)
      - server/index.ts:32-38 (rate limiter configuration)
    validation:
      - Must be positive integer
      - Recommended: 300000-900000 (5-15 minutes)
  
  - name: LOG_FORMAT
    required: false
    purpose: Structured logging output format
    format: json | pretty | plain
    default: plain
    options:
      json: Machine-readable JSON logs for production
      pretty: Human-readable with emojis for development
      plain: Simple text format (default)
    security_level: low
    code_locations:
      - server/index.ts:49 (initialization)
      - server/index.ts:51-77 (logRequest function)
    validation:
      - Must be one of: json, pretty, plain
      - Recommend json for production
  
  - name: PORT
    required: false
    purpose: TCP port for HTTP server binding
    format: integer (1-65535)
    default: 5000
    security_level: low
    code_locations:
      - server/index.ts:138 (port parsing)
    validation:
      - Must be valid port number (1-65535)
      - Replit restricts to configured PORT only
  
  - name: NODE_ENV
    required: false
    purpose: Node.js environment identifier
    format: development | production | staging | test
    default: development
    security_level: low
    impact:
      - Controls Vite dev server vs static serving
      - Affects logging behavior
      - Guards destructive migration scripts
    code_locations:
      - server/index.ts:127 (Vite conditional setup)
      - server/migrations/migrate.ts:5 (safety guard)
      - vite.config.ts:10 (plugin loading)
    validation:
      - Should be explicitly set in production
      - Must be 'development' for destructive migrations
  
  # ============================================
  # OPTIONAL (THIRD-PARTY INTEGRATIONS)
  # ============================================
  
  - name: TWELVEDATA_API_KEY
    required: false
    required_profiles: [production]
    purpose: API key for Twelve Data market data provider (forex, crypto, commodities)
    format: Provider-specific API key
    provider: https://twelvedata.com/
    security_level: medium
    fallback_behavior: Application uses mock data if not configured
    code_locations:
      - server/websocket.ts:5 (WebSocket market data)
      - server/services/market.service.ts:6 (REST API quotes)
      - server/import-symbols.ts:6 (symbol import script)
      - server/import-all-symbols.ts:6 (bulk import script)
    validation:
      - Must be valid Twelve Data API key
      - Should be tested for connectivity
  
  - name: MARKETAUX_API_KEY
    required: false
    purpose: API key for Marketaux financial news aggregation
    format: Provider-specific API key
    provider: https://www.marketaux.com/
    security_level: low
    fallback_behavior: News feature disabled without key
    code_locations:
      - server/services/news.service.ts:5 (news API)
    validation:
      - Must be valid Marketaux API key
  
  - name: EODHD_API_KEY
    required: false
    purpose: API key for EODHD economic calendar data
    format: Provider-specific API key
    provider: https://eodhd.com/
    security_level: low
    fallback_behavior: Economic calendar feature disabled
    code_locations:
      - server/services/economic.service.ts:5 (economic calendar API)
    validation:
      - Must be valid EODHD API key
  
  # ============================================
  # ADVANCED / FEATURE FLAGS
  # ============================================
  
  - name: WEBHOOK_TOLERANCE_SEC
    required: false
    purpose: Timestamp tolerance in seconds for webhook replay attack prevention
    format: integer (seconds)
    default: 300 (5 minutes)
    security_level: medium
    feature_status: Not yet implemented (reserved for future use)
    intended_use: Reject webhooks with timestamps older than tolerance
  
  - name: ALLOW_DESTRUCTIVE_MIGRATIONS
    required: false
    purpose: Explicit confirmation flag for running destructive migrations in non-dev
    format: boolean (true/false)
    default: false
    security_level: critical
    danger_level: EXTREME
    code_locations:
      - server/migrations/migrate.ts:6 (safety guard)
    validation:
      - Must be explicitly set to 'true' (string)
      - Should only be used with full database backup
      - Triggers 5-second countdown before execution
  
  # ============================================
  # DEPRECATED (DO NOT USE)
  # ============================================
  
  - name: SITE_WEBHOOK_SECRET
    required: false
    deprecated: true
    replacement: WEBHOOK_SECRET
    deprecation_notice: Logs warning if used, support will be removed in future release
    security_level: critical (if used)
    code_locations:
      - server/crm.ts:14-17 (deprecation warning)
    migration_steps:
      - Set WEBHOOK_SECRET environment variable
      - Remove SITE_WEBHOOK_SECRET
      - Verify logs show no deprecation warnings

# ============================================
# WEBHOOKS INVENTORY
# ============================================

webhooks:
  outbound:
    - id: deposit.completed
      direction: Trading Platform -> CRM
      purpose: Notify CRM of completed deposit transaction
      target_url_env: CRM_BASE_URL
      endpoint_path: /api/webhooks/trading
      authentication:
        - HMAC-SHA256 signature (X-Webhook-Signature header)
        - Bearer token (Authorization header via CRM_SERVICE_TOKEN)
      payload_schema:
        event: deposit.completed
        data:
          accountId: string
          fundType: string
          amount: string
          transactionId: string
          completedAt: timestamp
      code_locations:
        - server/routes.ts:503-511 (trigger after deposit)
        - server/crm.ts:138-167 (sendWebhook function)
      retry_policy: No retry (silent failure)
    
    - id: withdrawal.completed
      direction: Trading Platform -> CRM
      purpose: Notify CRM of completed withdrawal transaction
      target_url_env: CRM_BASE_URL
      endpoint_path: /api/webhooks/trading
      authentication: Same as deposit.completed
      code_locations:
        - server/routes.ts:572-580
        - server/crm.ts:138-167
    
    - id: order.placed
      direction: Trading Platform -> CRM
      purpose: Notify CRM when trading order is placed
      target_url_env: CRM_BASE_URL
      endpoint_path: /api/webhooks/trading
      authentication: Same as deposit.completed
      code_locations:
        - server/services/trading.service.ts:222-231 (market orders)
        - server/services/trading.service.ts:274-281 (pending orders)
        - server/crm.ts:138-167
    
    - id: order.executed
      direction: Trading Platform -> CRM
      purpose: Notify CRM when market order is executed
      target_url_env: CRM_BASE_URL
      endpoint_path: /api/webhooks/trading
      authentication: Same as deposit.completed
      code_locations:
        - server/services/trading.service.ts:234-241
        - server/crm.ts:138-167
    
    - id: position.opened
      direction: Trading Platform -> CRM
      purpose: Notify CRM when trading position is opened
      target_url_env: CRM_BASE_URL
      endpoint_path: /api/webhooks/trading
      authentication: Same as deposit.completed
      code_locations:
        - server/services/trading.service.ts:243-256
        - server/crm.ts:138-167
    
    - id: position.closed
      direction: Trading Platform -> CRM
      purpose: Notify CRM when trading position is closed
      target_url_env: CRM_BASE_URL
      endpoint_path: /api/webhooks/trading
      authentication: Same as deposit.completed
      code_locations:
        - server/services/trading.service.ts:360-371
        - server/crm.ts:138-167
  
  inbound:
    - id: sso-token-generation
      direction: CRM -> Trading Platform
      purpose: Generate SSO impersonation token for user
      endpoint: POST /api/crm/sso-token
      authentication: Bearer token (CRM_SERVICE_TOKEN)
      payload_schema:
        userId: string
        adminId: string
        reason: string
      response:
        ssoToken: string
        expiresAt: timestamp
        loginUrl: string
      code_locations:
        - server/crm.ts:15-55
      security_notes: Rate limited via /api/crm path
    
    - id: sso-login
      direction: CRM -> Trading Platform (redirect)
      purpose: Consume SSO token to log in user
      endpoint: GET /api/crm/sso-login?token=<token>
      authentication: None (token is single-use, expires in 10 minutes)
      code_locations:
        - server/crm.ts:58-95
    
    - id: get-user-info
      direction: CRM -> Trading Platform
      purpose: Fetch user profile data
      endpoint: GET /api/crm/users/:userId
      authentication: Bearer token (CRM_SERVICE_TOKEN)
      response: Sanitized user object (password excluded)
      code_locations:
        - server/crm.ts:98-134
      security_notes: Rate limited via /api/crm path

# ============================================
# OPERATIONAL PROFILES
# ============================================

profiles:
  development:
    required_vars:
      - DATABASE_URL
      - JWT_ACCESS_SECRET
      - JWT_REFRESH_SECRET
    optional_vars:
      - PORT
      - NODE_ENV
      - LOG_FORMAT
    security_notes:
      - Mock data used if market data API keys not provided
      - Destructive migrations allowed by default
      - CORS not enforced
  
  staging:
    required_vars:
      - DATABASE_URL
      - JWT_ACCESS_SECRET
      - JWT_REFRESH_SECRET
      - WEBHOOK_SECRET
      - CRM_BASE_URL
      - CRM_SERVICE_TOKEN
    recommended_vars:
      - NODE_ENV=staging
      - LOG_FORMAT=json
      - CORS_ALLOWED_ORIGINS
      - RATE_LIMIT_MAX
      - RATE_LIMIT_WINDOW_MS
    security_notes:
      - Should use separate database from production
      - Test CRM integration in staging first
      - Destructive migrations blocked unless explicitly allowed
  
  production:
    required_vars:
      - DATABASE_URL
      - JWT_ACCESS_SECRET
      - JWT_REFRESH_SECRET
      - WEBHOOK_SECRET
      - CRM_BASE_URL
      - CRM_SERVICE_TOKEN
      - TWELVEDATA_API_KEY
      - MARKETAUX_API_KEY
      - EODHD_API_KEY
      - NODE_ENV=production
      - LOG_FORMAT=json
      - CORS_ALLOWED_ORIGINS
      - RATE_LIMIT_MAX
      - RATE_LIMIT_WINDOW_MS
    security_requirements:
      - All secrets rotated quarterly
      - HTTPS enforced for all external URLs
      - Destructive migrations permanently blocked
      - Rate limiting mandatory
      - CORS strictly configured
      - Secret management service recommended (Vault, AWS Secrets Manager)
      - Audit logging enabled

# ============================================
# ROTATION SCHEDULE RECOMMENDATIONS
# ============================================

rotation_schedule:
  quarterly:
    - JWT_ACCESS_SECRET
    - JWT_REFRESH_SECRET
  
  coordinated_with_crm:
    - WEBHOOK_SECRET (requires dual-secret acceptance window)
    - CRM_SERVICE_TOKEN (requires synchronized update)
    - DATABASE_URL (requires new user creation, then cleanup)
  
  on_demand:
    - TWELVEDATA_API_KEY (if compromised or rate limits changed)
    - MARKETAUX_API_KEY (if compromised)
    - EODHD_API_KEY (if compromised)
  
  emergency_only:
    - DATABASE_URL (requires CRM coordination and downtime)

# END OF MANIFEST
